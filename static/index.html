<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aegis Tuner Pro</title>
<style>
:root {
  --bg: #0a0a0f; --surface: #14141f; --surface2: #1e1e2e;
  --border: #2a2a3e; --text: #e0e0e8; --dim: #888;
  --accent: #6c5ce7; --accent2: #a29bfe; --green: #00b894;
  --red: #ff6b6b; --orange: #fdcb6e; --blue: #74b9ff;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
h1,h2,h3 { font-weight:600; }

.app { max-width:1200px; margin:0 auto; padding:20px; }
.header { text-align:center; padding:30px 0 20px; border-bottom:1px solid var(--border); margin-bottom:24px; }
.header h1 { font-size:28px; background:linear-gradient(135deg,var(--accent),var(--accent2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
.header p { color:var(--dim); margin-top:6px; font-size:14px; }

.card { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:20px; margin-bottom:16px; }
.card h2 { font-size:16px; margin-bottom:12px; display:flex; align-items:center; gap:8px; }
.card h3 { font-size:14px; margin-bottom:8px; color:var(--accent2); }

.grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
.grid-3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px; }
.grid-4 { display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:12px; }
@media(max-width:768px) { .grid-2,.grid-3,.grid-4 { grid-template-columns:1fr; } }

.upload-zone { border:2px dashed var(--border); border-radius:12px; padding:40px; text-align:center; cursor:pointer; transition:all .2s; }
.upload-zone:hover { border-color:var(--accent); background:rgba(108,92,231,.05); }
.upload-zone.dragover { border-color:var(--green); background:rgba(0,184,148,.1); }
.upload-zone input { display:none; }
.upload-icon { font-size:48px; margin-bottom:12px; }

.btn { padding:10px 20px; border-radius:8px; border:none; cursor:pointer; font-size:14px; font-weight:500; transition:all .15s; display:inline-flex; align-items:center; gap:6px; }
.btn-primary { background:var(--accent); color:#fff; }
.btn-primary:hover { background:var(--accent2); }
.btn-primary:disabled { opacity:.5; cursor:not-allowed; }
.btn-secondary { background:var(--surface2); color:var(--text); border:1px solid var(--border); }
.btn-secondary:hover { border-color:var(--accent); }
.btn-green { background:var(--green); color:#fff; }
.btn-red { background:var(--red); color:#fff; }
.btn-full { width:100%; justify-content:center; }
.btn-sm { padding:6px 12px; font-size:12px; }

.input-group { margin-bottom:12px; }
.input-group label { display:block; font-size:12px; color:var(--dim); margin-bottom:4px; }
.input-group input, .input-group select { width:100%; padding:8px 12px; background:var(--surface2); border:1px solid var(--border); border-radius:6px; color:var(--text); font-size:14px; }
.input-group input:focus, .input-group select:focus { outline:none; border-color:var(--accent); }
input[type="range"] { -webkit-appearance:none; width:100%; height:6px; background:var(--surface2); border-radius:3px; border:none; }
input[type="range"]::-webkit-slider-thumb { -webkit-appearance:none; width:16px; height:16px; background:var(--accent); border-radius:50%; cursor:pointer; }

.slider-row { display:flex; align-items:center; gap:12px; }
.slider-row input[type="range"] { flex:1; }
.slider-val { min-width:48px; text-align:right; font-size:13px; color:var(--accent2); font-variant-numeric:tabular-nums; }

.metric { text-align:center; padding:12px; background:var(--surface2); border-radius:8px; }
.metric .value { font-size:24px; font-weight:700; color:var(--accent2); }
.metric .label { font-size:11px; color:var(--dim); margin-top:4px; }

audio { width:100%; margin:8px 0; border-radius:8px; }

.crossfader { display:flex; align-items:center; gap:12px; padding:12px 0; }
.crossfader span { font-size:12px; color:var(--dim); white-space:nowrap; }
.crossfader input { flex:1; }

.status { padding:10px 16px; border-radius:8px; margin:8px 0; font-size:13px; }
.status-info { background:rgba(116,185,255,.1); border-left:3px solid var(--blue); }
.status-success { background:rgba(0,184,148,.1); border-left:3px solid var(--green); }
.status-error { background:rgba(255,107,107,.1); border-left:3px solid var(--red); }
.status-loading { background:rgba(253,203,110,.1); border-left:3px solid var(--orange); }

.spinner { display:inline-block; width:16px; height:16px; border:2px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin .6s linear infinite; }
@keyframes spin { to { transform:rotate(360deg); } }

.hidden { display:none !important; }

.check-row { display:flex; align-items:center; gap:8px; margin:8px 0; font-size:13px; cursor:pointer; }
.check-row input[type="checkbox"] { accent-color:var(--accent); }

.tag { display:inline-block; padding:3px 8px; border-radius:4px; font-size:11px; font-weight:600; }
.tag-main { background:rgba(108,92,231,.2); color:var(--accent2); }
.tag-safe { background:rgba(0,184,148,.2); color:var(--green); }
.tag-technique { background:rgba(253,203,110,.2); color:var(--orange); }

.needs-analysis { opacity:.4; pointer-events:none; }
.needs-analysis.active { opacity:1; pointer-events:auto; }

::-webkit-scrollbar { width:6px; height:6px; }
::-webkit-scrollbar-track { background:var(--bg); }
::-webkit-scrollbar-thumb { background:var(--border); border-radius:3px; }

.sep { border:none; border-top:1px solid var(--border); margin:16px 0; }

/* â”€â”€â”€ Piano Roll DAW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pr-container { position:relative; width:100%; border-radius:8px; overflow:hidden; background:var(--surface2); }
.pr-toolbar { display:flex; align-items:center; gap:8px; padding:8px 12px; background:var(--surface); border-bottom:1px solid var(--border); flex-wrap:wrap; }
.pr-toolbar .btn { padding:6px 10px; font-size:12px; }
.pr-toolbar .sep-v { width:1px; height:20px; background:var(--border); }
.pr-zoom-group { display:flex; align-items:center; gap:4px; font-size:11px; color:var(--dim); }
.pr-zoom-group input[type="range"] { width:80px; height:4px; }
.pr-time-display { font-family:monospace; font-size:12px; color:var(--accent2); margin-left:auto; }

.pr-body { display:flex; position:relative; }
.pr-keys { width:48px; min-width:48px; background:var(--surface); border-right:1px solid var(--border); overflow:hidden; z-index:2; }
.pr-keys canvas { display:block; }
.pr-scroll { flex:1; overflow:auto; position:relative; }
.pr-scroll canvas { display:block; cursor:crosshair; }
.pr-scroll.mode-select canvas { cursor:default; }
.pr-scroll.mode-erase canvas { cursor:not-allowed; }

/* Note editor popup */
.note-popup { position:absolute; background:var(--surface); border:1px solid var(--accent); border-radius:8px; padding:12px; z-index:100; min-width:200px; box-shadow:0 8px 24px rgba(0,0,0,.5); }
.note-popup h4 { font-size:13px; margin-bottom:8px; color:var(--accent2); }
.note-popup .input-row { display:flex; align-items:center; gap:8px; margin:4px 0; font-size:12px; }
.note-popup .input-row label { min-width:60px; color:var(--dim); }
.note-popup .input-row input { width:80px; padding:4px 6px; background:var(--surface2); border:1px solid var(--border); border-radius:4px; color:var(--text); font-size:12px; }
.note-popup .btn-row { display:flex; gap:6px; margin-top:8px; }
</style>
</head>
<body>

<div class="app">
  <div class="header">
    <h1>Aegis Tuner Pro</h1>
    <p>AI ì˜¤ë””ì˜¤ â†’ MIDI ë³€í™˜ ì—”ì§„</p>
  </div>

  <!-- Upload Section -->
  <div class="card" id="upload-card">
    <h2>ì˜¤ë””ì˜¤ ì—…ë¡œë“œ</h2>
    <div class="upload-zone" id="upload-zone" onclick="document.getElementById('file-input').click()">
      <div class="upload-icon">ğŸ¸</div>
      <div>ì—¬ê¸°ì— íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì„ íƒ</div>
      <div style="color:var(--dim);font-size:12px;margin-top:8px">MP3, WAV ì§€ì›</div>
      <input type="file" id="file-input" accept=".mp3,.wav,.m4a,.ogg,.flac">
    </div>
    <div id="file-info" class="hidden" style="margin-top:12px">
      <div class="status status-success" id="file-status"></div>
    </div>
  </div>

  <!-- Analysis Parameters -->
  <div class="card" id="params-card">
    <h2>ë¶„ì„ íŒŒë¼ë¯¸í„°</h2>
    <div class="grid-3">
      <div class="input-group">
        <label>ì‹ ë¢°ë„ ê¸°ì¤€ê°’</label>
        <div class="slider-row">
          <input type="range" id="p-confidence" min="0.1" max="0.95" step="0.05" value="0.30" title="ë‚®ì„ìˆ˜ë¡ ë…¸íŠ¸ë¥¼ ë§ì´ ë½‘ê³ , ë†’ì„ìˆ˜ë¡ í™•ì‹¤í•œ ë…¸íŠ¸ë§Œ ë‚¨ê¹ë‹ˆë‹¤">
          <span class="slider-val" id="v-confidence">0.30</span>
        </div>
      </div>
      <div class="input-group">
        <label>ìµœì†Œ ë…¸íŠ¸ ê¸¸ì´ (ms)</label>
        <div class="slider-row">
          <input type="range" id="p-mindur" min="10" max="500" step="10" value="30" title="ì´ ì‹œê°„ë³´ë‹¤ ì§§ì€ ë…¸íŠ¸ëŠ” ë¬´ì‹œë©ë‹ˆë‹¤. ë¹ ë¥¸ ì—°ì£¼ëŠ” ë‚®ê²Œ ì„¤ì •">
          <span class="slider-val" id="v-mindur">30</span>
        </div>
      </div>
      <div class="input-group">
        <label>ì„œìŠ¤í…Œì¸ (ms)</label>
        <div class="slider-row">
          <input type="range" id="p-sustain" min="0" max="1000" step="50" value="200" title="ê°™ì€ ìŒì´ ëŠê²¼ë‹¤ ì´ì–´ì§ˆ ë•Œ ì—°ê²°í•´ì£¼ëŠ” ì‹œê°„. ë†’ì„ìˆ˜ë¡ ë ˆê°€í† ">
          <span class="slider-val" id="v-sustain">200</span>
        </div>
      </div>
    </div>
    <div class="grid-2" style="margin-top:12px">
      <div class="input-group">
        <label>ë ˆì´í¬ ê°ë„</label>
        <div class="slider-row">
          <input type="range" id="p-rake" min="0.1" max="1.0" step="0.1" value="0.6" title="ê¸°íƒ€ ë ˆì´í¬(ë¹ ë¥¸ ê¸ê¸°) ê°ì§€ ë¯¼ê°ë„. ë†’ì„ìˆ˜ë¡ ë ˆì´í¬ë¥¼ ì ê·¹ ì œê±°">
          <span class="slider-val" id="v-rake">0.6</span>
        </div>
      </div>
      <div class="input-group">
        <label>ì‹œì‘ / ë ì‹œê°„ (ì´ˆ)</label>
        <div style="display:flex;gap:8px">
          <input type="number" id="p-start" value="0" min="0" step="1" style="width:50%" title="ë¶„ì„ ì‹œì‘ ì§€ì  (ì´ˆ)">
          <input type="number" id="p-end" value="" placeholder="ë (ìë™)" style="width:50%" title="ë¶„ì„ ë ì§€ì . ë¹„ì›Œë‘ë©´ ì „ì²´ ë¶„ì„">
        </div>
      </div>
    </div>
    <div style="display:flex;gap:12px;margin-top:16px">
      <button class="btn btn-primary btn-full" id="btn-analyze" disabled title="ì˜¤ë””ì˜¤ë¥¼ ë¶„ì„í•˜ì—¬ MIDI ë…¸íŠ¸ë¥¼ ì¶”ì¶œí•©ë‹ˆë‹¤">ë¶„ì„ ì‹œì‘</button>
      <button class="btn btn-secondary" id="btn-refilter" disabled style="white-space:nowrap" title="íŒŒë¼ë¯¸í„°ë§Œ ë³€ê²½í•˜ì—¬ ë¹ ë¥´ê²Œ ì¬ì ìš© (ì¬ë¶„ì„ ì—†ì´)">ì¬í•„í„°</button>
    </div>
    <div id="analyze-status" class="hidden"></div>
  </div>

  <!-- Results -->
  <div id="results-section" class="needs-analysis">

    <!-- â•â•â• PIANO ROLL DAW â•â•â• -->
    <div class="card" style="padding:12px">
      <div class="pr-container">
        <!-- Toolbar -->
        <div class="pr-toolbar">
          <button class="btn btn-sm btn-green" id="pr-play" title="ì¬ìƒ/ì¼ì‹œì •ì§€ (Space)">&#9654; ì¬ìƒ</button>
          <button class="btn btn-sm btn-secondary" id="pr-stop" title="ì •ì§€ (ì²˜ìŒìœ¼ë¡œ)">&#9632; ì •ì§€</button>
          <div class="sep-v"></div>
          <button class="btn btn-sm btn-secondary pr-mode active" data-mode="select" title="ë…¸íŠ¸ ì„ íƒ/ì´ë™ (Sí‚¤)">&#9995; ì„ íƒ</button>
          <button class="btn btn-sm btn-secondary pr-mode" data-mode="draw" title="ë…¸íŠ¸ ê·¸ë¦¬ê¸° (Dí‚¤)">&#9998; ê·¸ë¦¬ê¸°</button>
          <button class="btn btn-sm btn-secondary pr-mode" data-mode="erase" title="ë…¸íŠ¸ ì§€ìš°ê¸° (Eí‚¤)">&#10060; ì§€ìš°ê¸°</button>
          <div class="sep-v"></div>
          <div class="pr-zoom-group">
            ê°€ë¡œ <input type="range" id="pr-zoom-x" min="0.5" max="8" step="0.1" value="1" title="ì‹œê°„ì¶• í™•ëŒ€/ì¶•ì†Œ">
          </div>
          <div class="pr-zoom-group">
            ì„¸ë¡œ <input type="range" id="pr-zoom-y" min="0.5" max="4" step="0.1" value="1" title="ìŒë†’ì´ì¶• í™•ëŒ€/ì¶•ì†Œ">
          </div>
          <div class="sep-v"></div>
          <label class="check-row" style="margin:0;font-size:11px">
            <input type="checkbox" id="pr-snap" checked title="ë…¸íŠ¸ë¥¼ ê²©ìì— ë§ì¶° ì •ë ¬"> ìŠ¤ëƒ…
          </label>
          <div class="pr-time-display" id="pr-time">0:00.000 / 0:00</div>
        </div>
        <!-- Body: Key labels + Scrollable canvas -->
        <div class="pr-body" style="height:400px">
          <div class="pr-keys"><canvas id="pr-keys-canvas"></canvas></div>
          <div class="pr-scroll" id="pr-scroll"><canvas id="pr-canvas"></canvas></div>
        </div>
      </div>
      <div style="margin-top:8px;font-size:12px;color:var(--dim);display:flex;align-items:center;gap:12px;flex-wrap:wrap">
        <span id="note-count">0</span>ê°œ ë…¸íŠ¸ &nbsp;
        <span class="tag tag-main" title="í™•ì‹¤í•˜ê²Œ ê°ì§€ëœ ë…¸íŠ¸">ë©”ì¸</span>
        <span class="tag tag-safe" title="ë‚®ì€ ì‹ ë¢°ë„ë¡œ ê°ì§€ëœ ë…¸íŠ¸">ë³´ì¡°</span>
        <span class="tag tag-technique" title="ë²¤ë“œ, ìŠ¬ë¼ì´ë“œ ë“± ê¸°íƒ€ í…Œí¬ë‹‰ì´ ê°ì§€ëœ ë…¸íŠ¸">í…Œí¬ë‹‰</span>
        <span style="margin-left:auto;font-size:11px;color:var(--dim)">Ctrl+íœ : í™•ëŒ€ | ë”ë¸”í´ë¦­: í¸ì§‘ | Del: ì‚­ì œ</span>
      </div>
    </div>

    <!-- â•â•â• FRET FILTER + GUITAR TAB â•â•â• -->
    <div class="card" id="fret-filter-card">
      <h2>ìš´ì§€ í•„í„°</h2>
      <p style="font-size:12px;color:var(--dim);margin-bottom:12px">ê¸°íƒ€ ìš´ì§€ ë¬¼ë¦¬ ë²•ì¹™ ê¸°ë°˜ìœ¼ë¡œ ë¶ˆê°€ëŠ¥í•œ ë…¸íŠ¸ ì „í™˜ì„ ìë™ ì œê±°í•©ë‹ˆë‹¤</p>
      <div class="grid-2">
        <div class="input-group">
          <label>ìµœëŒ€ í”„ë › ì´ë™ ì†ë„ (í”„ë ›/ì´ˆ)</label>
          <div class="slider-row">
            <input type="range" id="ff-speed" min="10" max="80" step="5" value="40" title="ì´ˆë‹¹ ìµœëŒ€ í”„ë › ì´ë™ ê±°ë¦¬. ë‚®ì¶œìˆ˜ë¡ ì—„ê²©í•˜ê²Œ í•„í„°ë§. 40ì´ ì¼ë°˜ì ì¸ ë¹ ë¥¸ ì—°ì£¼ ê¸°ì¤€">
            <span class="slider-val" id="v-ff-speed">40</span>
          </div>
        </div>
        <div class="input-group">
          <label>ë³´í˜¸ ë…¸íŠ¸ ê¸¸ì´ (ms)</label>
          <div class="slider-row">
            <input type="range" id="ff-protect" min="50" max="500" step="50" value="200" title="ì´ ê¸¸ì´ ì´ìƒì˜ ë…¸íŠ¸ëŠ” ì ˆëŒ€ ì‚­ì œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ê¸´ ìŒì€ í™•ì‹¤í•œ ìŒì´ë¯€ë¡œ ë³´í˜¸">
            <span class="slider-val" id="v-ff-protect">200</span>
          </div>
        </div>
      </div>
      <button class="btn btn-primary btn-full" id="btn-fret-filter" title="ìš´ì§€ í•„í„°ë¥¼ ì ìš©í•˜ì—¬ ë¬¼ë¦¬ì ìœ¼ë¡œ ë¶ˆê°€ëŠ¥í•œ ë…¸íŠ¸ë¥¼ ì œê±°í•©ë‹ˆë‹¤">ìš´ì§€ í•„í„° ì ìš©</button>
      <div id="ff-results" class="hidden" style="margin-top:12px">
        <div class="grid-3" id="ff-metrics"></div>
        <div id="ff-removed-list" style="margin-top:8px;max-height:120px;overflow-y:auto;font-size:11px;color:var(--dim)"></div>
      </div>
      <div id="ff-status" class="hidden"></div>
    </div>

    <!-- Guitar Tablature -->
    <div class="card" id="tab-card">
      <h2>ê¸°íƒ€ íƒ­ ì•…ë³´</h2>
      <div class="pr-toolbar" style="margin-bottom:0">
        <button class="btn btn-sm btn-primary" id="btn-gen-tab" title="ê°ì§€ëœ ë…¸íŠ¸ë¥¼ ê¸°íƒ€ íƒ­ ì•…ë³´ë¡œ ë³€í™˜í•©ë‹ˆë‹¤">íƒ­ ìƒì„±</button>
        <div class="sep-v"></div>
        <div class="pr-zoom-group">
          í™•ëŒ€ <input type="range" id="tab-zoom" min="0.5" max="4" step="0.1" value="1" title="íƒ­ ì•…ë³´ ê°€ë¡œ í™•ëŒ€/ì¶•ì†Œ">
        </div>
      </div>
      <div id="tab-scroll" style="overflow-x:auto;overflow-y:hidden;max-height:200px;background:var(--surface2);border-radius:0 0 8px 8px">
        <canvas id="tab-canvas"></canvas>
      </div>
      <div style="margin-top:8px;font-size:12px;color:var(--dim);display:flex;align-items:center;gap:12px">
        <span id="tab-note-count">0</span>ê°œ ë§¤í•‘ &nbsp;
        <span class="tag" style="background:rgba(0,184,148,.2);color:var(--green)" title="ì¤„ì„ ë°€ì–´ ìŒì„ ì˜¬ë¦¬ëŠ” ì£¼ë²•">ë²¤ë“œ</span>
        <span class="tag" style="background:rgba(162,155,254,.2);color:var(--accent2)" title="í”„ë ›ì„ ë¯¸ë„ëŸ¬ì§€ë©° ì´ë™í•˜ëŠ” ì£¼ë²•">ìŠ¬ë¼ì´ë“œ</span>
        <span class="tag" style="background:rgba(253,203,110,.2);color:var(--orange)" title="ì™¼ì†ìœ¼ë¡œ í”„ë ›ì„ ë•Œë ¤ ì†Œë¦¬ë‚´ëŠ” ì£¼ë²•">í•´ë¨¸ì˜¨</span>
        <span class="tag" style="background:rgba(253,121,168,.2);color:#fd79a8" title="í”„ë ›ì—ì„œ ì†ê°€ë½ì„ ë–¼ë©´ì„œ ì†Œë¦¬ë‚´ëŠ” ì£¼ë²•">í’€ì˜¤í”„</span>
      </div>
    </div>

    <!-- ì˜¤ë””ì˜¤ í¬ë¡œìŠ¤í˜ì´ë” -->
    <div class="card">
      <h2>ì˜¤ë””ì˜¤ í¬ë¡œìŠ¤í˜ì´ë”</h2>
      <div class="crossfader">
        <span>ì›ë³¸</span>
        <input type="range" id="crossfade-slider" min="0" max="1" step="0.05" value="0.5" title="ì›ë³¸ê³¼ MIDI í•©ì„±ìŒì˜ ë¹„ìœ¨ì„ ì¡°ì ˆí•©ë‹ˆë‹¤">
        <span>MIDI</span>
      </div>
      <div class="grid-3" style="margin-bottom:8px">
        <div style="text-align:left;font-size:12px;color:var(--dim)" id="cf-orig-pct">50%</div>
        <div style="text-align:center"><button class="btn btn-sm btn-secondary" id="btn-crossfade" title="ì„¤ì •ëœ ë¹„ìœ¨ë¡œ ì›ë³¸+MIDI ë¯¹ìŠ¤ ìƒì„±">ë¯¹ìŠ¤ ìƒì„±</button></div>
        <div style="text-align:right;font-size:12px;color:var(--dim)" id="cf-midi-pct">50%</div>
      </div>
      <audio id="audio-mix" controls class="hidden"></audio>
      <hr class="sep">
      <div class="grid-2">
        <div>
          <button class="btn btn-sm btn-secondary btn-full" id="btn-play-orig" title="ì—…ë¡œë“œí•œ ì›ë³¸ ì˜¤ë””ì˜¤ ì¬ìƒ">ì›ë³¸ ì˜¤ë””ì˜¤</button>
          <audio id="audio-orig" controls class="hidden" style="margin-top:6px"></audio>
        </div>
        <div>
          <button class="btn btn-sm btn-secondary btn-full" id="btn-play-midi" title="MIDI ë³€í™˜ ê²°ê³¼ë¥¼ í•©ì„±ìŒìœ¼ë¡œ ì¬ìƒ">MIDI ì˜¤ë””ì˜¤</button>
          <audio id="audio-midi" controls class="hidden" style="margin-top:6px"></audio>
        </div>
      </div>
    </div>

    <!-- ë‚´ë³´ë‚´ê¸° -->
    <div class="card">
      <h2>ë‚´ë³´ë‚´ê¸°</h2>
      <button class="btn btn-green btn-full" id="btn-download-midi" title="ë³€í™˜ëœ MIDI íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤">MIDI ë‹¤ìš´ë¡œë“œ</button>
    </div>

    <!-- ADSR ì‹ ìŠ¤ -->
    <div class="card">
      <h2>ADSR ì†Œí”„íŠ¸ ì‹ ìŠ¤</h2>
      <p style="font-size:12px;color:var(--dim);margin-bottom:12px">íŒŒí˜•/ì—”ë²¨ë¡œí”„ íŠœë‹ìœ¼ë¡œ ì›ë³¸ ìŒìƒ‰ì— ë§ì¶”ê¸°</p>
      <div class="grid-2">
        <div class="input-group">
          <label>ê¸°íƒ€ í”„ë¦¬ì…‹</label>
          <select id="adsr-preset" title="ê¸°íƒ€ ì¢…ë¥˜ì— ë”°ë¥¸ ìŒìƒ‰ í”„ë¦¬ì…‹ ì„ íƒ">
            <option value="nylon">ë‚˜ì¼ë¡  (í´ë˜ì‹)</option>
            <option value="steel">ìŠ¤í‹¸ (ì–´ì¿ ìŠ¤í‹±)</option>
            <option value="electric_clean" selected>ì¼ë ‰ í´ë¦°</option>
            <option value="electric_overdrive">ì¼ë ‰ ì˜¤ë²„ë“œë¼ì´ë¸Œ</option>
            <option value="muted">ë®¤íŠ¸</option>
          </select>
        </div>
        <div style="display:flex;align-items:end">
          <label class="check-row"><input type="checkbox" id="adsr-envelope-match" title="ì›ë³¸ ì˜¤ë””ì˜¤ì˜ ì—”ë²¨ë¡œí”„ë¥¼ ë¶„ì„í•˜ì—¬ ìë™ ë§¤ì¹­"> ì—”ë²¨ë¡œí”„ ìë™ ë§¤ì¹­</label>
        </div>
      </div>
      <div id="adsr-preset-info" style="font-size:11px;color:var(--dim);margin:8px 0"></div>
      <button class="btn btn-primary btn-full" id="btn-adsr-synth" title="ì„ íƒí•œ í”„ë¦¬ì…‹ìœ¼ë¡œ MIDIë¥¼ í•©ì„±í•©ë‹ˆë‹¤">ADSR í•©ì„±</button>
      <audio id="audio-adsr" controls class="hidden" style="margin-top:8px"></audio>
      <div id="adsr-status" class="hidden"></div>
    </div>

    <!-- ì—­ë¶„ì„ -->
    <div class="card">
      <h2>ì—­ë¶„ì„ ê²€ì¦</h2>
      <p style="font-size:12px;color:var(--dim);margin-bottom:12px">MIDIâ†’WAVâ†’MIDI ì—­ë³€í™˜ìœ¼ë¡œ ì •í™•ë„ë¥¼ ê²€ì¦í•©ë‹ˆë‹¤</p>
      <button class="btn btn-primary btn-full" id="btn-reverse" title="ë³€í™˜ ê²°ê³¼ë¥¼ ë‹¤ì‹œ ì—­ë³€í™˜í•˜ì—¬ ì •í™•ë„ë¥¼ ì¸¡ì •í•©ë‹ˆë‹¤">ì—­ë¶„ì„ ì‹¤í–‰</button>
      <div id="reverse-results" class="hidden" style="margin-top:12px"><div class="grid-3" id="reverse-metrics"></div></div>
      <div id="reverse-status" class="hidden"></div>
    </div>

    <!-- ìë™ íŒŒë¼ë¯¸í„° ë§¤ì¹­ -->
    <div class="card">
      <h2>ìë™ íŒŒë¼ë¯¸í„° ë§¤ì¹­</h2>
      <p style="font-size:12px;color:var(--dim);margin-bottom:12px">ê·¸ë¦¬ë“œ ì„œì¹˜ë¡œ ìµœì ì˜ ë¶„ì„ íŒŒë¼ë¯¸í„°ë¥¼ ìë™ íƒìƒ‰í•©ë‹ˆë‹¤</p>
      <button class="btn btn-primary btn-full" id="btn-automatch" title="ìµœì ì˜ ì‹ ë¢°ë„/ê¸¸ì´/ì„œìŠ¤í…Œì¸ ê°’ì„ ìë™ìœ¼ë¡œ ì°¾ìŠµë‹ˆë‹¤">ìë™ ë§¤ì¹­</button>
      <div id="automatch-results" class="hidden" style="margin-top:12px"></div>
      <div id="automatch-status" class="hidden"></div>
    </div>

    <!-- ì´í™íŠ¸ í•™ìŠµ ë£¨í”„ -->
    <div class="card">
      <h2>ì´í™íŠ¸ í•™ìŠµ ë£¨í”„</h2>
      <p style="font-size:12px;color:var(--dim);margin-bottom:12px">MIDI + ì´í™íŠ¸ â†’ ì¬ë¶„ì„ì„ ë°˜ë³µí•˜ì—¬ ìŒìƒ‰ì„ ìµœì í™”í•©ë‹ˆë‹¤</p>
      <div class="grid-2">
        <div class="input-group">
          <label>ì´í™íŠ¸ í”„ë¦¬ì…‹</label>
          <select id="effect-preset" title="ì ìš©í•  ì´í™íŠ¸ ì¢…ë¥˜ë¥¼ ì„ íƒí•©ë‹ˆë‹¤"></select>
        </div>
        <div class="input-group">
          <label>ìµœëŒ€ ë°˜ë³µ íšŸìˆ˜</label>
          <div class="slider-row">
            <input type="range" id="effect-iters" min="1" max="10" step="1" value="5" title="í•™ìŠµ ë£¨í”„ë¥¼ ëª‡ ë²ˆ ë°˜ë³µí• ì§€ ì„¤ì •í•©ë‹ˆë‹¤">
            <span class="slider-val" id="v-effect-iters">5</span>
          </div>
        </div>
      </div>
      <button class="btn btn-primary btn-full" id="btn-effect-loop" title="ì´í™íŠ¸ í•™ìŠµ ë£¨í”„ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤">í•™ìŠµ ë£¨í”„ ì‹œì‘</button>
      <div id="effect-results" class="hidden" style="margin-top:12px"></div>
      <div id="effect-status" class="hidden"></div>
    </div>

    <!-- ë…¸íŠ¸ë³„ ìµœì í™” -->
    <div class="card">
      <h2>ë…¸íŠ¸ë³„ ìµœì í™”</h2>
      <p style="font-size:12px;color:var(--dim);margin-bottom:12px">ê° ë…¸íŠ¸ë§ˆë‹¤ ê°œë³„ ADSR íŒŒë¼ë¯¸í„°ë¥¼ ìµœì í™”í•©ë‹ˆë‹¤ (ë©€í‹°í”„ë¡œì„¸ì‹±)</p>
      <div class="grid-2">
        <label class="check-row"><input type="checkbox" id="pno-quick" checked title="ë¹ ë¥¸ ë¶„ì„ ëª¨ë“œ. í•´ì œí•˜ë©´ 27ê°œ ì¡°í•©ì„ ì‹œë„í•˜ì—¬ ì •ë°€ ë¶„ì„"> ë¹ ë¥¸ ëª¨ë“œ</label>
        <label class="check-row"><input type="checkbox" id="pno-parallel" checked title="CPU ì½”ì–´ë¥¼ í™œìš©í•œ ë³‘ë ¬ ì²˜ë¦¬"> ë³‘ë ¬ ì²˜ë¦¬</label>
      </div>
      <button class="btn btn-primary btn-full" id="btn-pno" title="ëª¨ë“  ë…¸íŠ¸ì— ëŒ€í•´ ê°œë³„ ìµœì í™”ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤">ë…¸íŠ¸ë³„ ìµœì í™” ì‹¤í–‰</button>
      <div id="pno-results" class="hidden" style="margin-top:12px"></div>
      <audio id="audio-pno" controls class="hidden" style="margin-top:8px"></audio>
      <div id="pno-status" class="hidden"></div>
    </div>

  </div>
</div>

<!-- ë…¸íŠ¸ í¸ì§‘ íŒì—… -->
<div class="note-popup hidden" id="note-popup">
  <h4>ë…¸íŠ¸ í¸ì§‘</h4>
  <div class="input-row"><label>ìŒë†’ì´</label><input type="number" id="np-note" min="0" max="127"><span id="np-name" style="font-size:11px;color:var(--dim)"></span></div>
  <div class="input-row"><label>ì„¸ê¸°</label><input type="number" id="np-vel" min="1" max="127"></div>
  <div class="input-row"><label>ì‹œì‘ (ms)</label><input type="number" id="np-start" min="0"></div>
  <div class="input-row"><label>ë (ms)</label><input type="number" id="np-end" min="0"></div>
  <div class="btn-row">
    <button class="btn btn-sm btn-primary" id="np-save">ì €ì¥</button>
    <button class="btn btn-sm btn-red" id="np-delete">ì‚­ì œ</button>
    <button class="btn btn-sm btn-secondary" id="np-cancel">ì·¨ì†Œ</button>
  </div>
</div>

<script>
// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let sessionId = null;
const API = '';

// â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function $(id) { return document.getElementById(id); }
function show(el) { el.classList.remove('hidden'); }
function hide(el) { el.classList.add('hidden'); }
function showStatus(elId, msg, type='info') {
  const el = $(elId);
  el.className = `status status-${type}`;
  el.innerHTML = type === 'loading' ? `<span class="spinner"></span> ${msg}` : msg;
  show(el);
}
function hideStatus(elId) { hide($(elId)); }
async function apiFetch(url, opts={}) {
  const resp = await fetch(API + url, opts);
  if (!resp.ok) {
    const err = await resp.json().catch(() => ({detail: resp.statusText}));
    throw new Error(err.detail || 'Request failed');
  }
  return resp;
}

const NOTE_NAMES = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
function noteName(n) { return NOTE_NAMES[n%12] + (Math.floor(n/12)-1); }

// â”€â”€â”€ Slider sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.slider-row input[type="range"]').forEach(slider => {
  const valSpan = slider.parentElement.querySelector('.slider-val');
  if (!valSpan) return;
  slider.oninput = () => valSpan.textContent = slider.value;
  valSpan.textContent = slider.value;
});
$('effect-iters').oninput = function() { $('v-effect-iters').textContent = this.value; };

// â”€â”€â”€ Debounce helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function debounce(fn, ms) { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); }; }

// â”€â”€â”€ Auto fret filter on slider change â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ìš´ì§€ í•„í„° ìŠ¬ë¼ì´ë”ë§Œ ì‹¤ì‹œê°„ ë°˜ì˜ (Analysis íŒŒë¼ë¯¸í„°ëŠ” ìˆ˜ë™)
// refilterë¡œ ì›ë³¸ ë³µì› â†’ fret filter ì ìš© ì²´ì´ë‹
let _ffPending = false;
const autoFretFilter = debounce(async () => {
  if (!sessionId || _ffPending) return;
  _ffPending = true;
  try {
    // 1. refilterë¡œ base events ë³µì›
    const rfParams = new URLSearchParams({
      confidence_threshold: $('p-confidence').value,
      min_note_duration_ms: $('p-mindur').value,
      sustain_ms: $('p-sustain').value,
    });
    await apiFetch(`/api/refilter/${sessionId}?${rfParams}`, { method:'POST' });
    // 2. fret filter ì ìš©
    const ffParams = new URLSearchParams({
      max_fret_speed: $('ff-speed').value,
      protect_long_notes_ms: $('ff-protect').value,
    });
    const ffResp = await apiFetch(`/api/fret-filter/${sessionId}?${ffParams}`, { method:'POST' });
    const ffData = await ffResp.json();
    const rpt = ffData.report || {};
    currentEvents = (ffData.events || []).map((e,i) => ({...e, _idx:i}));
    $('note-count').textContent = currentEvents.length;
    prState.selectedNote = null;
    drawPR();
    $('ff-metrics').innerHTML = `
      <div class="metric"><div class="value">${rpt.original_count||0}</div><div class="label">ì›ë³¸</div></div>
      <div class="metric"><div class="value" style="color:var(--green)">${rpt.filtered_count||0}</div><div class="label">ìœ ì§€</div></div>
      <div class="metric"><div class="value" style="color:var(--red)">${rpt.removed_count||0}</div><div class="label">ì œê±°</div></div>`;
    show($('ff-results'));
    if (tabData.length > 0) {
      tabData = generateTabData(currentEvents);
      drawTab(tabData);
      $('tab-note-count').textContent = tabData.length;
    }
  } catch(e) { console.warn('Auto fret filter error:', e); }
  finally { _ffPending = false; }
}, 500);

['ff-speed','ff-protect'].forEach(id => {
  $(id).addEventListener('input', autoFretFilter);
});

$('crossfade-slider').oninput = function() {
  const v = parseFloat(this.value);
  $('cf-orig-pct').textContent = `${((1-v)*100).toFixed(0)}%`;
  $('cf-midi-pct').textContent = `${(v*100).toFixed(0)}%`;
};

// â”€â”€â”€ Upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const uploadZone = $('upload-zone'), fileInput = $('file-input');
['dragenter','dragover'].forEach(e => uploadZone.addEventListener(e, ev => { ev.preventDefault(); uploadZone.classList.add('dragover'); }));
['dragleave','drop'].forEach(e => uploadZone.addEventListener(e, ev => { ev.preventDefault(); uploadZone.classList.remove('dragover'); }));
uploadZone.addEventListener('drop', ev => { if (ev.dataTransfer.files[0]) uploadFile(ev.dataTransfer.files[0]); });
fileInput.addEventListener('change', () => { if (fileInput.files[0]) uploadFile(fileInput.files[0]); });

async function uploadFile(file) {
  showStatus('file-status', `${file.name} ì—…ë¡œë“œ ì¤‘...`); show($('file-info'));
  const form = new FormData(); form.append('file', file);
  try {
    const resp = await apiFetch('/api/upload', { method:'POST', body:form });
    const data = await resp.json();
    sessionId = data.session_id;
    $('file-status').className = 'status status-success';
    $('file-status').textContent = `${data.file_name} ì—…ë¡œë“œ ì™„ë£Œ (ì„¸ì…˜: ${sessionId})`;
    $('btn-analyze').disabled = false;
  } catch(e) { showStatus('file-status', `ì—…ë¡œë“œ ì‹¤íŒ¨: ${e.message}`, 'error'); }
}

// â”€â”€â”€ Analyze â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('btn-analyze').onclick = async () => {
  if (!sessionId) return;
  $('btn-analyze').disabled = true;
  showStatus('analyze-status', 'ì˜¤ë””ì˜¤ ë¶„ì„ ì¤‘...', 'loading'); show($('analyze-status'));
  try {
    const params = new URLSearchParams({
      start_time: $('p-start').value||0, confidence_threshold: $('p-confidence').value,
      min_note_duration_ms: $('p-mindur').value, sustain_ms: $('p-sustain').value, rake_sensitivity: $('p-rake').value,
    });
    if ($('p-end').value) params.append('end_time', $('p-end').value);
    const resp = await apiFetch(`/api/analyze/${sessionId}?${params}`, { method:'POST' });
    const data = await resp.json();
    onAnalysisComplete(data);
    showStatus('analyze-status', `${data.num_events}ê°œ ë…¸íŠ¸ ê°ì§€ë¨`, 'success');
    // Preload original audio for piano roll playback
    loadOriginalAudioForPR();
  } catch(e) { showStatus('analyze-status', e.message, 'error'); }
  finally { $('btn-analyze').disabled = false; }
};

$('btn-refilter').onclick = async () => {
  if (!sessionId) return;
  $('btn-refilter').disabled = true;
  showStatus('analyze-status', 'ì¬í•„í„° ì ìš© ì¤‘...', 'loading'); show($('analyze-status'));
  try {
    const params = new URLSearchParams({
      confidence_threshold: $('p-confidence').value, min_note_duration_ms: $('p-mindur').value, sustain_ms: $('p-sustain').value,
    });
    const resp = await apiFetch(`/api/refilter/${sessionId}?${params}`, { method:'POST' });
    const data = await resp.json();
    onAnalysisComplete(data);
    showStatus('analyze-status', `ì¬í•„í„° ì™„ë£Œ: ${data.num_events}ê°œ ë…¸íŠ¸`, 'success');
  } catch(e) { showStatus('analyze-status', e.message, 'error'); }
  finally { $('btn-refilter').disabled = false; }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â• PIANO ROLL DAW ENGINE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let currentEvents = [];
let prState = {
  zoomX: 1, zoomY: 1,
  scrollX: 0, scrollY: 0,
  mode: 'select',        // select | draw | erase
  playing: false,
  playStartTime: 0,
  playOffset: 0,         // ms offset when play started
  animFrame: null,
  selectedNote: null,     // index into currentEvents
  dragging: null,         // {type:'move'|'resize-l'|'resize-r', idx, startX, startY, origEvent}
  drawPreview: null,      // {note, start} while drawing
  // Computed bounds
  minNote: 36, maxNote: 84, maxEndMs: 10000,
  // Audio
  audioBuffer: null,
  audioContext: null,
  audioSource: null,
};

const PR_NOTE_H_BASE = 12;
const PR_MS_PER_PX_BASE = 4; // 1px = 4ms at zoom 1
const PR_KEYS_W = 48;
const SNAP_MS = 50; // 50ms snap grid

function onAnalysisComplete(data) {
  currentEvents = (data.events || []).map((e,i) => ({...e, _idx: i}));
  $('note-count').textContent = data.num_events;
  $('btn-refilter').disabled = false;
  $('results-section').classList.add('active');

  // Compute bounds
  if (currentEvents.length) {
    prState.minNote = 127; prState.maxNote = 0; prState.maxEndMs = 0;
    currentEvents.forEach(e => {
      if (e.note < prState.minNote) prState.minNote = e.note;
      if (e.note > prState.maxNote) prState.maxNote = e.note;
      if (e.end > prState.maxEndMs) prState.maxEndMs = e.end;
    });
    prState.minNote = Math.max(0, prState.minNote - 4);
    prState.maxNote = Math.min(127, prState.maxNote + 4);
    prState.maxEndMs = Math.max(prState.maxEndMs + 2000, 5000);
  }

  prState.selectedNote = null;
  hideNotePopup();
  prStopPlayback();
  drawPR();

  hide($('audio-mix')); hide($('audio-orig')); hide($('audio-midi'));
  hide($('audio-adsr')); hide($('audio-pno'));
}

// â”€â”€â”€ Dimensions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function prNoteH() { return PR_NOTE_H_BASE * prState.zoomY; }
function prMsPerPx() { return PR_MS_PER_PX_BASE / prState.zoomX; }
function prNoteRange() { return prState.maxNote - prState.minNote + 1; }
function prCanvasW() { return Math.max(800, prState.maxEndMs / prMsPerPx()); }
function prCanvasH() { return prNoteRange() * prNoteH(); }

// â”€â”€â”€ Coordinate conversions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function msToX(ms) { return ms / prMsPerPx(); }
function xToMs(x) { return x * prMsPerPx(); }
function noteToY(note) { return (prState.maxNote - note) * prNoteH(); }
function yToNote(y) { return prState.maxNote - Math.floor(y / prNoteH()); }
function snapMs(ms) { return $('pr-snap').checked ? Math.round(ms / SNAP_MS) * SNAP_MS : ms; }

// â”€â”€â”€ Draw â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawPR() {
  const canvas = $('pr-canvas');
  const scroll = $('pr-scroll');
  const cW = prCanvasW();
  const cH = prCanvasH();
  const dpr = window.devicePixelRatio || 1;

  canvas.width = cW * dpr;
  canvas.height = cH * dpr;
  canvas.style.width = cW + 'px';
  canvas.style.height = cH + 'px';

  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

  const nh = prNoteH();
  const nr = prNoteRange();

  // Background
  ctx.fillStyle = '#12121f';
  ctx.fillRect(0, 0, cW, cH);

  // Horizontal lines + black key shading
  for (let n = prState.minNote; n <= prState.maxNote; n++) {
    const y = noteToY(n);
    const pc = n % 12;
    if ([1,3,6,8,10].includes(pc)) {
      ctx.fillStyle = 'rgba(255,255,255,0.025)';
      ctx.fillRect(0, y, cW, nh);
    }
    ctx.strokeStyle = '#1e1e30';
    ctx.lineWidth = (pc === 0) ? 1.5 : 0.5;
    ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(cW, y); ctx.stroke();
  }

  // Vertical grid (time)
  const gridMs = prState.zoomX >= 2 ? 500 : (prState.zoomX >= 1 ? 1000 : 2000);
  ctx.strokeStyle = '#1a1a2e'; ctx.lineWidth = 0.5;
  for (let ms = 0; ms <= prState.maxEndMs; ms += gridMs) {
    const x = msToX(ms);
    ctx.strokeStyle = (ms % (gridMs*4) === 0) ? '#2a2a44' : '#1a1a2e';
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, cH); ctx.stroke();
    // Time label
    if (ms % (gridMs*2) === 0) {
      ctx.fillStyle = '#444';
      ctx.font = '10px monospace';
      ctx.fillText(`${(ms/1000).toFixed(1)}s`, x+3, 10);
    }
  }

  // Snap grid (finer)
  if ($('pr-snap').checked && prState.zoomX >= 2) {
    ctx.strokeStyle = 'rgba(108,92,231,0.07)'; ctx.lineWidth = 0.3;
    for (let ms = 0; ms <= prState.maxEndMs; ms += SNAP_MS) {
      const x = msToX(ms);
      ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,cH); ctx.stroke();
    }
  }

  // Note colors
  const colors = {
    normal:'#6c5ce7', hammer_on:'#fdcb6e', pull_off:'#fd79a8',
    bend:'#00b894', vibrato:'#74b9ff', slide:'#a29bfe'
  };
  const safeColor = '#00b894';

  // Draw notes
  currentEvents.forEach((e, i) => {
    const x = msToX(e.start);
    const w = Math.max(3, msToX(e.end) - x);
    const y = noteToY(e.note);
    const h = nh - 1;

    const isSelected = (prState.selectedNote === i);
    const baseColor = (e.track === 'safe') ? safeColor : (colors[e.technique] || colors.normal);

    // Fill
    ctx.globalAlpha = isSelected ? 1 : (0.4 + (e.velocity / 127) * 0.55);
    ctx.fillStyle = baseColor;
    const r = Math.min(3, h/2);
    ctx.beginPath(); ctx.roundRect(x, y, w, h, r); ctx.fill();

    // Border
    ctx.globalAlpha = isSelected ? 1 : 0.6;
    ctx.strokeStyle = isSelected ? '#fff' : baseColor;
    ctx.lineWidth = isSelected ? 2 : 1;
    ctx.stroke();

    // Velocity bar (small indicator at left)
    ctx.globalAlpha = 0.7;
    ctx.fillStyle = '#fff';
    const vBar = (e.velocity / 127) * (h - 4);
    ctx.fillRect(x+1, y + h - vBar - 2, 2, vBar);

    // Note name on larger notes
    if (w > 30 && nh >= 10) {
      ctx.globalAlpha = 0.8;
      ctx.fillStyle = '#fff';
      ctx.font = `${Math.min(10, nh-3)}px sans-serif`;
      ctx.fillText(noteName(e.note), x+6, y+h-3);
    }

    ctx.globalAlpha = 1;

    // Resize handles for selected
    if (isSelected) {
      ctx.fillStyle = '#fff';
      ctx.fillRect(x, y, 4, h); // left handle
      ctx.fillRect(x+w-4, y, 4, h); // right handle
    }
  });

  // Draw preview (when drawing new note)
  if (prState.drawPreview) {
    const dp = prState.drawPreview;
    const x = msToX(dp.start);
    const w = Math.max(3, msToX(dp.end || dp.start + 100) - x);
    const y = noteToY(dp.note);
    ctx.globalAlpha = 0.5;
    ctx.fillStyle = '#6c5ce7';
    ctx.fillRect(x, y, w, nh-1);
    ctx.globalAlpha = 1;
  }

  // Draw piano keys sidebar
  drawPRKeys();

  // Playhead
  if (prState.playing || prState.playOffset > 0) {
    drawPlayhead();
  }
}

function drawPRKeys() {
  const keysCanvas = $('pr-keys-canvas');
  const nh = prNoteH();
  const cH = prCanvasH();
  const dpr = window.devicePixelRatio || 1;

  keysCanvas.width = PR_KEYS_W * dpr;
  keysCanvas.height = cH * dpr;
  keysCanvas.style.width = PR_KEYS_W + 'px';
  keysCanvas.style.height = cH + 'px';

  const ctx = keysCanvas.getContext('2d');
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

  ctx.fillStyle = '#0e0e1a';
  ctx.fillRect(0, 0, PR_KEYS_W, cH);

  for (let n = prState.minNote; n <= prState.maxNote; n++) {
    const y = noteToY(n);
    const pc = n % 12;
    const isBlack = [1,3,6,8,10].includes(pc);

    ctx.fillStyle = isBlack ? '#1a1a2a' : '#252538';
    ctx.fillRect(0, y, PR_KEYS_W-1, nh-1);

    ctx.strokeStyle = '#0e0e1a';
    ctx.lineWidth = 0.5;
    ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(PR_KEYS_W,y); ctx.stroke();

    // Label
    if (pc === 0 || nh >= 14) {
      ctx.fillStyle = isBlack ? '#666' : '#999';
      ctx.font = `${Math.min(10, nh-2)}px sans-serif`;
      ctx.textAlign = 'center';
      ctx.fillText(noteName(n), PR_KEYS_W/2, y + nh - 2);
    }
  }
}

// Sync scroll between keys and main canvas
$('pr-scroll').addEventListener('scroll', function() {
  $('pr-keys-canvas').style.marginTop = -this.scrollTop + 'px';
});

// â”€â”€â”€ Playhead â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawPlayhead() {
  const canvas = $('pr-canvas');
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const currentMs = getCurrentPlayMs();
  const x = msToX(currentMs) * dpr;

  // Draw line
  ctx.save();
  ctx.setTransform(1,0,0,1,0,0);
  ctx.strokeStyle = '#ff4757';
  ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();

  // Triangle at top
  ctx.fillStyle = '#ff4757';
  ctx.beginPath(); ctx.moveTo(x-6, 0); ctx.lineTo(x+6, 0); ctx.lineTo(x, 10*dpr); ctx.fill();
  ctx.restore();
}

function getCurrentPlayMs() {
  if (prState.playing) {
    return prState.playOffset + (performance.now() - prState.playStartTime);
  }
  return prState.playOffset;
}

function updateTimeDisplay() {
  const ms = getCurrentPlayMs();
  const totalMs = prState.maxEndMs;
  const fmt = (m) => {
    const s = Math.floor(m/1000);
    const min = Math.floor(s/60);
    const sec = s % 60;
    const mss = Math.floor(m%1000);
    return `${min}:${String(sec).padStart(2,'0')}.${String(mss).padStart(3,'0')}`;
  };
  const fmtShort = (m) => {
    const s = Math.floor(m/1000);
    return `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;
  };
  $('pr-time').textContent = `${fmt(ms)} / ${fmtShort(totalMs)}`;
}

// â”€â”€â”€ Playback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let prAudioCtx = null;
let prAudioBuffer = null;
let prAudioSource = null;

function loadOriginalAudioForPR() {
  if (!sessionId) return;
  fetch(`/api/original-wav/${sessionId}`)
    .then(r => r.arrayBuffer())
    .then(buf => {
      if (!prAudioCtx) prAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
      return prAudioCtx.decodeAudioData(buf);
    })
    .then(decoded => { prAudioBuffer = decoded; })
    .catch(e => console.warn('Failed to load audio for PR', e));
}

function prStartPlayback() {
  if (prState.playing) return;
  prState.playing = true;
  prState.playStartTime = performance.now();
  $('pr-play').innerHTML = '&#10074;&#10074; ì¼ì‹œì •ì§€';

  // Start audio
  if (prAudioBuffer && prAudioCtx) {
    prAudioSource = prAudioCtx.createBufferSource();
    prAudioSource.buffer = prAudioBuffer;
    prAudioSource.connect(prAudioCtx.destination);
    prAudioSource.start(0, prState.playOffset / 1000);
    prAudioSource.onended = () => {
      if (prState.playing) prStopPlayback();
    };
  }

  function animate() {
    if (!prState.playing) return;
    drawPR();
    updateTimeDisplay();
    // Auto-scroll to follow playhead
    const scroll = $('pr-scroll');
    const phX = msToX(getCurrentPlayMs());
    const visLeft = scroll.scrollLeft;
    const visRight = visLeft + scroll.clientWidth;
    if (phX > visRight - 50 || phX < visLeft) {
      scroll.scrollLeft = phX - 100;
    }
    prState.animFrame = requestAnimationFrame(animate);
  }
  animate();
}

function prPausePlayback() {
  if (!prState.playing) return;
  prState.playOffset = getCurrentPlayMs();
  prState.playing = false;
  $('pr-play').innerHTML = '&#9654; ì¬ìƒ';
  if (prState.animFrame) cancelAnimationFrame(prState.animFrame);
  if (prAudioSource) { try { prAudioSource.stop(); } catch(e){} prAudioSource = null; }
  drawPR();
  updateTimeDisplay();
}

function prStopPlayback() {
  prState.playing = false;
  prState.playOffset = 0;
  $('pr-play').innerHTML = '&#9654; ì¬ìƒ';
  if (prState.animFrame) cancelAnimationFrame(prState.animFrame);
  if (prAudioSource) { try { prAudioSource.stop(); } catch(e){} prAudioSource = null; }
  drawPR();
  updateTimeDisplay();
}

$('pr-play').onclick = () => {
  if (prState.playing) prPausePlayback();
  else prStartPlayback();
};
$('pr-stop').onclick = () => prStopPlayback();

// â”€â”€â”€ Zoom controls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('pr-zoom-x').oninput = function() { prState.zoomX = parseFloat(this.value); drawPR(); };
$('pr-zoom-y').oninput = function() { prState.zoomY = parseFloat(this.value); drawPR(); };

// Mouse wheel zoom
$('pr-scroll').addEventListener('wheel', function(e) {
  if (e.ctrlKey || e.metaKey) {
    e.preventDefault();
    const delta = e.deltaY > 0 ? -0.15 : 0.15;
    if (e.shiftKey) {
      prState.zoomY = Math.max(0.5, Math.min(4, prState.zoomY + delta));
      $('pr-zoom-y').value = prState.zoomY;
    } else {
      prState.zoomX = Math.max(0.5, Math.min(8, prState.zoomX + delta));
      $('pr-zoom-x').value = prState.zoomX;
    }
    drawPR();
  }
}, { passive: false });

// â”€â”€â”€ Mode switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.pr-mode').forEach(btn => {
  btn.onclick = function() {
    document.querySelectorAll('.pr-mode').forEach(b => b.classList.remove('active'));
    this.classList.add('active');
    prState.mode = this.dataset.mode;
    const scroll = $('pr-scroll');
    scroll.className = 'pr-scroll mode-' + prState.mode;
  };
});

// â”€â”€â”€ Mouse interaction on canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const prCanvas = $('pr-canvas');
const prScroll = $('pr-scroll');

function getCanvasPos(e) {
  const rect = prCanvas.getBoundingClientRect();
  const scaleX = prCanvas.clientWidth / parseFloat(prCanvas.style.width || prCanvas.clientWidth);
  return {
    x: (e.clientX - rect.left) / scaleX,
    y: (e.clientY - rect.top) / scaleX,
  };
}

function findNoteAt(x, y) {
  const ms = xToMs(x);
  const note = yToNote(y);
  const nh = prNoteH();
  for (let i = currentEvents.length - 1; i >= 0; i--) {
    const e = currentEvents[i];
    if (e.note === note && ms >= e.start && ms <= e.end) {
      return i;
    }
  }
  return -1;
}

function isOnLeftHandle(x, idx) {
  const e = currentEvents[idx];
  return Math.abs(x - msToX(e.start)) < 6;
}
function isOnRightHandle(x, idx) {
  const e = currentEvents[idx];
  return Math.abs(x - msToX(e.end)) < 6;
}

prCanvas.addEventListener('mousedown', function(e) {
  const pos = getCanvasPos(e);
  const ms = xToMs(pos.x);
  const note = yToNote(pos.y);

  if (prState.mode === 'select') {
    const idx = findNoteAt(pos.x, pos.y);
    if (idx >= 0) {
      prState.selectedNote = idx;
      // Check handles
      if (isOnLeftHandle(pos.x, idx)) {
        prState.dragging = { type:'resize-l', idx, startX:pos.x, orig:{...currentEvents[idx]} };
      } else if (isOnRightHandle(pos.x, idx)) {
        prState.dragging = { type:'resize-r', idx, startX:pos.x, orig:{...currentEvents[idx]} };
      } else {
        prState.dragging = { type:'move', idx, startX:pos.x, startY:pos.y, orig:{...currentEvents[idx]} };
      }
      drawPR();
    } else {
      prState.selectedNote = null;
      // Click on empty = set playhead
      prState.playOffset = Math.max(0, snapMs(ms));
      if (prState.playing) {
        prPausePlayback();
        prStartPlayback();
      }
      hideNotePopup();
      drawPR();
      updateTimeDisplay();
    }
  }
  else if (prState.mode === 'draw') {
    const startMs = snapMs(Math.max(0, ms));
    prState.drawPreview = { note: note, start: startMs, end: startMs + 100 };
    prState.dragging = { type:'draw', startX: pos.x };
    drawPR();
  }
  else if (prState.mode === 'erase') {
    const idx = findNoteAt(pos.x, pos.y);
    if (idx >= 0) {
      currentEvents.splice(idx, 1);
      prState.selectedNote = null;
      $('note-count').textContent = currentEvents.length;
      drawPR();
    }
  }
});

prCanvas.addEventListener('mousemove', function(e) {
  if (!prState.dragging) {
    // Cursor change for handles
    if (prState.mode === 'select') {
      const pos = getCanvasPos(e);
      const idx = findNoteAt(pos.x, pos.y);
      if (idx >= 0 && (isOnLeftHandle(pos.x, idx) || isOnRightHandle(pos.x, idx))) {
        prCanvas.style.cursor = 'ew-resize';
      } else if (idx >= 0) {
        prCanvas.style.cursor = 'grab';
      } else {
        prCanvas.style.cursor = 'default';
      }
    }
    return;
  }

  const pos = getCanvasPos(e);
  const dx = pos.x - prState.dragging.startX;

  if (prState.dragging.type === 'move') {
    const orig = prState.dragging.orig;
    const dy = pos.y - prState.dragging.startY;
    const newNote = yToNote(noteToY(orig.note) + dy);
    const deltaMs = xToMs(dx);
    const newStart = snapMs(Math.max(0, orig.start + deltaMs));
    const dur = orig.end - orig.start;
    currentEvents[prState.dragging.idx].start = newStart;
    currentEvents[prState.dragging.idx].end = newStart + dur;
    currentEvents[prState.dragging.idx].note = Math.max(0, Math.min(127, newNote));
    drawPR();
  }
  else if (prState.dragging.type === 'resize-l') {
    const orig = prState.dragging.orig;
    const deltaMs = xToMs(dx);
    const newStart = snapMs(Math.max(0, Math.min(orig.end - 10, orig.start + deltaMs)));
    currentEvents[prState.dragging.idx].start = newStart;
    drawPR();
  }
  else if (prState.dragging.type === 'resize-r') {
    const orig = prState.dragging.orig;
    const deltaMs = xToMs(dx);
    const newEnd = snapMs(Math.max(orig.start + 10, orig.end + deltaMs));
    currentEvents[prState.dragging.idx].end = newEnd;
    drawPR();
  }
  else if (prState.dragging.type === 'draw') {
    const endMs = snapMs(Math.max(0, xToMs(pos.x)));
    if (prState.drawPreview) {
      prState.drawPreview.end = Math.max(prState.drawPreview.start + SNAP_MS, endMs);
    }
    drawPR();
  }
});

window.addEventListener('mouseup', function(e) {
  if (prState.dragging) {
    if (prState.dragging.type === 'draw' && prState.drawPreview) {
      // Finalize new note
      const dp = prState.drawPreview;
      if (dp.end - dp.start >= 20) {
        currentEvents.push({
          note: dp.note,
          start: Math.min(dp.start, dp.end),
          end: Math.max(dp.start, dp.end),
          velocity: 80,
          track: 'main',
          technique: 'normal',
        });
        $('note-count').textContent = currentEvents.length;
        prState.maxEndMs = Math.max(prState.maxEndMs, dp.end + 2000);
      }
      prState.drawPreview = null;
    }
    // Show popup for select mode
    if (prState.dragging.type === 'move' && prState.selectedNote !== null) {
      const scrollRect = prScroll.getBoundingClientRect();
      const ev = currentEvents[prState.selectedNote];
      const px = msToX(ev.start) - prScroll.scrollLeft + scrollRect.left;
      const py = noteToY(ev.note) - prScroll.scrollTop + scrollRect.top;
      // Only show if it was a click (not a drag)
      const dx2 = e.clientX - prState.dragging.startX;
      // We skip popup if dragged significantly
    }
    prState.dragging = null;
    drawPR();
  }
});

// Double-click to open editor
prCanvas.addEventListener('dblclick', function(e) {
  const pos = getCanvasPos(e);
  const idx = findNoteAt(pos.x, pos.y);
  if (idx >= 0) {
    prState.selectedNote = idx;
    drawPR();
    showNotePopup(idx, e.clientX, e.clientY);
  }
});

// â”€â”€â”€ Note editor popup â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showNotePopup(idx, cx, cy) {
  const ev = currentEvents[idx];
  const popup = $('note-popup');
  $('np-note').value = ev.note;
  $('np-vel').value = ev.velocity;
  $('np-start').value = Math.round(ev.start);
  $('np-end').value = Math.round(ev.end);
  $('np-name').textContent = noteName(ev.note);

  popup.style.left = Math.min(cx, window.innerWidth - 220) + 'px';
  popup.style.top = Math.min(cy + 10, window.innerHeight - 200) + 'px';
  show(popup);
}

function hideNotePopup() { hide($('note-popup')); }

$('np-note').oninput = function() { $('np-name').textContent = noteName(parseInt(this.value)||0); };

$('np-save').onclick = () => {
  if (prState.selectedNote === null) return;
  const ev = currentEvents[prState.selectedNote];
  ev.note = Math.max(0, Math.min(127, parseInt($('np-note').value)||60));
  ev.velocity = Math.max(1, Math.min(127, parseInt($('np-vel').value)||80));
  ev.start = Math.max(0, parseInt($('np-start').value)||0);
  ev.end = Math.max(ev.start+10, parseInt($('np-end').value)||0);
  hideNotePopup();
  drawPR();
};

$('np-delete').onclick = () => {
  if (prState.selectedNote === null) return;
  currentEvents.splice(prState.selectedNote, 1);
  prState.selectedNote = null;
  $('note-count').textContent = currentEvents.length;
  hideNotePopup();
  drawPR();
};

$('np-cancel').onclick = () => hideNotePopup();

// â”€â”€â”€ Keyboard shortcuts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown', function(e) {
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
  if (e.code === 'Space') { e.preventDefault(); $('pr-play').click(); }
  if (e.code === 'Delete' || e.code === 'Backspace') {
    if (prState.selectedNote !== null) {
      currentEvents.splice(prState.selectedNote, 1);
      prState.selectedNote = null;
      $('note-count').textContent = currentEvents.length;
      hideNotePopup(); drawPR();
    }
  }
  if (e.code === 'Escape') { prState.selectedNote = null; hideNotePopup(); drawPR(); }
  if (e.code === 'KeyS') { document.querySelector('.pr-mode[data-mode="select"]').click(); }
  if (e.code === 'KeyD') { document.querySelector('.pr-mode[data-mode="draw"]').click(); }
  if (e.code === 'KeyE') { document.querySelector('.pr-mode[data-mode="erase"]').click(); }
});

// â”€â”€â”€ Resize â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('resize', () => { if (currentEvents.length) drawPR(); });

// â•â•â• END PIANO ROLL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€â”€ Download MIDI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('btn-download-midi').onclick = () => {
  if (!sessionId) return;
  window.open(`/api/midi/${sessionId}`, '_blank');
};

// â”€â”€â”€ Audio Players â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('btn-play-orig').onclick = async () => {
  const el = $('audio-orig');
  if (!el.classList.contains('hidden')) { hide(el); return; }
  el.src = `/api/original-wav/${sessionId}`; show(el);
};
$('btn-play-midi').onclick = async () => {
  const el = $('audio-midi');
  if (!el.classList.contains('hidden')) { hide(el); return; }
  el.src = `/api/midi-wav/${sessionId}`; show(el);
};

// â”€â”€â”€ Crossfader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('btn-crossfade').onclick = async () => {
  if (!sessionId) return;
  const btn = $('btn-crossfade'); btn.disabled = true; btn.textContent = 'ë¯¹ì‹± ì¤‘...';
  try {
    const cf = $('crossfade-slider').value;
    const resp = await apiFetch(`/api/crossfade/${sessionId}?crossfade=${cf}`, { method:'POST' });
    const blob = await resp.blob();
    $('audio-mix').src = URL.createObjectURL(blob); show($('audio-mix'));
  } catch(e) { alert('í¬ë¡œìŠ¤í˜ì´ë“œ ì‹¤íŒ¨: ' + e.message); }
  finally { btn.disabled = false; btn.textContent = 'ë¯¹ìŠ¤ ìƒì„±'; }
};

// â”€â”€â”€ ADSR Synth â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const presetInfo = { nylon:'A:5ms D:80ms S:0.6 R:200ms | Triangle', steel:'A:3ms D:60ms S:0.5 R:150ms | Sawtooth', electric_clean:'A:5ms D:40ms S:0.7 R:100ms | Sawtooth', electric_overdrive:'A:2ms D:30ms S:0.8 R:300ms | Square', muted:'A:2ms D:20ms S:0.2 R:30ms | Sawtooth' };
$('adsr-preset').onchange = function() { $('adsr-preset-info').textContent = presetInfo[this.value]||''; };
$('adsr-preset').dispatchEvent(new Event('change'));

$('btn-adsr-synth').onclick = async () => {
  if (!sessionId) return;
  const btn = $('btn-adsr-synth'); btn.disabled = true;
  showStatus('adsr-status', 'ADSR í•©ì„± ì¤‘...', 'loading'); show($('adsr-status'));
  try {
    const params = new URLSearchParams({ preset: $('adsr-preset').value, envelope_match: $('adsr-envelope-match').checked });
    const resp = await apiFetch(`/api/adsr-synth/${sessionId}?${params}`, { method:'POST' });
    const data = await resp.json();
    const bytes = atob(data.wav_base64); const arr = new Uint8Array(bytes.length);
    for (let i=0;i<bytes.length;i++) arr[i]=bytes.charCodeAt(i);
    $('audio-adsr').src = URL.createObjectURL(new Blob([arr],{type:'audio/wav'})); show($('audio-adsr'));
    let msg = 'ADSR í•©ì„± ì™„ë£Œ!';
    if (data.envelope_params) { const ep=data.envelope_params; msg+=` (A:${ep.attack_ms}ms D:${ep.decay_ms}ms S:${ep.sustain_level} R:${ep.release_ms}ms)`; }
    showStatus('adsr-status', msg, 'success');
  } catch(e) { showStatus('adsr-status', e.message, 'error'); }
  finally { btn.disabled = false; }
};

// â”€â”€â”€ Reverse Analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('btn-reverse').onclick = async () => {
  if (!sessionId) return;
  const btn = $('btn-reverse'); btn.disabled = true;
  showStatus('reverse-status', 'ì—­ë¶„ì„ ì‹¤í–‰ ì¤‘...', 'loading'); show($('reverse-status'));
  try {
    const resp = await apiFetch(`/api/reverse-analysis/${sessionId}`, { method:'POST' }); const data = await resp.json();
    $('reverse-metrics').innerHTML = `
      <div class="metric"><div class="value">${(data.note_accuracy*100).toFixed(1)}%</div><div class="label">ìŒì •</div></div>
      <div class="metric"><div class="value">${(data.pitch_accuracy*100).toFixed(1)}%</div><div class="label">í”¼ì¹˜</div></div>
      <div class="metric"><div class="value">${(data.timing_accuracy*100).toFixed(1)}%</div><div class="label">íƒ€ì´ë°</div></div>`;
    show($('reverse-results'));
    showStatus('reverse-status', `ì›ë³¸: ${data.original_notes} â†’ ì—­ë³€í™˜: ${data.reversed_notes}ê°œ ë…¸íŠ¸`, 'success');
  } catch(e) { showStatus('reverse-status', e.message, 'error'); }
  finally { btn.disabled = false; }
};

// â”€â”€â”€ Auto Match â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('btn-automatch').onclick = async () => {
  if (!sessionId) return;
  const btn = $('btn-automatch'); btn.disabled = true;
  showStatus('automatch-status', 'ìë™ ë§¤ì¹­ ì¤‘...', 'loading'); show($('automatch-status'));
  try {
    const resp = await apiFetch(`/api/auto-match/${sessionId}`, { method:'POST' }); const data = await resp.json();
    $('automatch-results').innerHTML = `
      <div class="grid-4">
        <div class="metric"><div class="value">${data.score?(data.score*100).toFixed(1)+'%':'N/A'}</div><div class="label">ì ìˆ˜</div></div>
        <div class="metric"><div class="value">${data.confidence_threshold?.toFixed(2)||'N/A'}</div><div class="label">ì‹ ë¢°ë„</div></div>
        <div class="metric"><div class="value">${data.min_note_duration_ms||'N/A'}</div><div class="label">ìµœì†Œ ê¸¸ì´</div></div>
        <div class="metric"><div class="value">${data.sustain_ms||'N/A'}</div><div class="label">ì„œìŠ¤í…Œì¸</div></div>
      </div>
      <button class="btn btn-green btn-full btn-sm" style="margin-top:12px" onclick="applyAutoMatch(${data.confidence_threshold},${data.min_note_duration_ms},${data.sustain_ms})">íŒŒë¼ë¯¸í„° ì ìš©</button>`;
    show($('automatch-results'));
    showStatus('automatch-status', 'ìë™ ë§¤ì¹­ ì™„ë£Œ!', 'success');
  } catch(e) { showStatus('automatch-status', e.message, 'error'); }
  finally { btn.disabled = false; }
};
function applyAutoMatch(c,d,s) {
  $('p-confidence').value=c; document.querySelector('#v-confidence').textContent=c.toFixed(2);
  $('p-mindur').value=d; document.querySelector('#v-mindur').textContent=d;
  $('p-sustain').value=s; document.querySelector('#v-sustain').textContent=s;
  $('btn-refilter').click();
}

// â”€â”€â”€ Effect Learning Loop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async()=>{try{
  const r=await apiFetch('/api/presets');const d=await r.json();const sel=$('effect-preset');
  (d.effect_presets||['clean']).forEach(p=>{const o=document.createElement('option');o.value=p;o.textContent=p;sel.appendChild(o);});
}catch(e){console.warn(e);}})();

$('btn-effect-loop').onclick = async () => {
  if (!sessionId) return;
  const btn = $('btn-effect-loop'); btn.disabled = true;
  showStatus('effect-status', 'í•™ìŠµ ë£¨í”„ ì‹¤í–‰ ì¤‘...', 'loading'); show($('effect-status'));
  try {
    const params = new URLSearchParams({ preset: $('effect-preset').value, max_iterations: $('effect-iters').value });
    const resp = await apiFetch(`/api/effect-loop/${sessionId}?${params}`, { method:'POST' }); const data = await resp.json();
    const a=data.best_accuracy||{}, bp=data.best_params||{};
    $('effect-results').innerHTML = `
      <div class="grid-4">
        <div class="metric"><div class="value">${((a.note_accuracy||0)*100).toFixed(1)}%</div><div class="label">ìŒì •</div></div>
        <div class="metric"><div class="value">${((a.pitch_accuracy||0)*100).toFixed(1)}%</div><div class="label">í”¼ì¹˜</div></div>
        <div class="metric"><div class="value">${((a.timing_accuracy||0)*100).toFixed(1)}%</div><div class="label">íƒ€ì´ë°</div></div>
        <div class="metric"><div class="value">${((a.overall||0)*100).toFixed(1)}%</div><div class="label">ì¢…í•©</div></div>
      </div>
      <div class="status status-info" style="margin-top:8px">ìµœì ê°’: ì‹ ë¢°ë„=${bp.confidence_threshold?.toFixed(2)} | ìµœì†Œê¸¸ì´=${bp.min_note_duration_ms}ms | ì„œìŠ¤í…Œì¸=${bp.sustain_ms}ms</div>`;
    show($('effect-results'));
    showStatus('effect-status', `í•™ìŠµ ì™„ë£Œ! ${data.iterations}íšŒ ë°˜ë³µ`, 'success');
  } catch(e) { showStatus('effect-status', e.message, 'error'); }
  finally { btn.disabled = false; }
};

// â”€â”€â”€ Per-Note Optimizer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
$('btn-pno').onclick = async () => {
  if (!sessionId) return;
  const btn = $('btn-pno'); btn.disabled = true;
  showStatus('pno-status', 'ë…¸íŠ¸ë³„ ìµœì í™” ì¤‘...', 'loading'); show($('pno-status'));
  try {
    const params = new URLSearchParams({ quick_mode: $('pno-quick').checked, parallel: $('pno-parallel').checked });
    const resp = await apiFetch(`/api/per-note-optimize/${sessionId}?${params}`, { method:'POST' }); const data = await resp.json();
    const r=data.report||{};
    $('pno-results').innerHTML = `
      <div class="grid-3">
        <div class="metric"><div class="value">${((r.avg_similarity||0)*100).toFixed(1)}%</div><div class="label">í‰ê·  ìœ ì‚¬ë„</div></div>
        <div class="metric"><div class="value">${((r.min_similarity||0)*100).toFixed(1)}%</div><div class="label">ìµœì†Œ</div></div>
        <div class="metric"><div class="value">${((r.max_similarity||0)*100).toFixed(1)}%</div><div class="label">ìµœëŒ€</div></div>
      </div>
      <div class="status status-info" style="margin-top:8px">í‰ê·  ADSR: A=${r.avg_attack_ms}ms D=${r.avg_decay_ms}ms S=${r.avg_sustain_level} R=${r.avg_release_ms}ms</div>`;
    show($('pno-results'));
    if (data.wav_base64) {
      const bytes=atob(data.wav_base64);const arr=new Uint8Array(bytes.length);
      for(let i=0;i<bytes.length;i++)arr[i]=bytes.charCodeAt(i);
      $('audio-pno').src=URL.createObjectURL(new Blob([arr],{type:'audio/wav'})); show($('audio-pno'));
    }
    showStatus('pno-status', `${r.total_notes||0}ê°œ ë…¸íŠ¸ ìµœì í™” ì™„ë£Œ!`, 'success');
  } catch(e) { showStatus('pno-status', e.message, 'error'); }
  finally { btn.disabled = false; }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â• GUITAR FRET FILTER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

$('ff-speed').oninput = function() { $('v-ff-speed').textContent = this.value; };
$('ff-protect').oninput = function() { $('v-ff-protect').textContent = this.value; };

$('btn-fret-filter').onclick = async () => {
  if (!sessionId) return;
  const btn = $('btn-fret-filter'); btn.disabled = true;
  showStatus('ff-status', 'ìš´ì§€ í•„í„° ì ìš© ì¤‘...', 'loading'); show($('ff-status'));
  try {
    const params = new URLSearchParams({
      max_fret_speed: $('ff-speed').value,
      protect_long_notes_ms: $('ff-protect').value,
    });
    const resp = await apiFetch(`/api/fret-filter/${sessionId}?${params}`, { method:'POST' });
    const data = await resp.json();
    const rpt = data.report || {};

    // Update piano roll
    currentEvents = (data.events || []).map((e,i) => ({...e, _idx:i}));
    $('note-count').textContent = currentEvents.length;
    prState.selectedNote = null;
    drawPR();

    // Show metrics
    $('ff-metrics').innerHTML = `
      <div class="metric"><div class="value">${rpt.original_count||0}</div><div class="label">ì›ë³¸</div></div>
      <div class="metric"><div class="value" style="color:var(--green)">${rpt.filtered_count||0}</div><div class="label">ìœ ì§€</div></div>
      <div class="metric"><div class="value" style="color:var(--red)">${rpt.removed_count||0}</div><div class="label">ì œê±°</div></div>`;

    // Show removed details
    const removed = rpt.removed_notes || [];
    if (removed.length > 0) {
      $('ff-removed-list').innerHTML = removed.map(r =>
        `<div style="padding:2px 0;border-bottom:1px solid var(--border)">` +
        `ë…¸íŠ¸ ${r.note} (${noteName(r.note)}) @ ${r.start} - ${r.reason}` +
        (r.required_speed ? ` (${r.required_speed} í”„ë ›/ì´ˆ, í—ˆìš©: ${r.max_allowed})` : '') +
        `</div>`
      ).join('');
    } else {
      $('ff-removed-list').innerHTML = '<div style="color:var(--green)">ë…¸ì´ì¦ˆ ì—†ìŒ</div>';
    }
    show($('ff-results'));

    showStatus('ff-status', `ìš´ì§€ í•„í„°: ${rpt.removed_count||0}ê°œ ì œê±°, ${rpt.filtered_count||0}ê°œ ìœ ì§€`, 'success');

    // Auto-regenerate tab if visible
    if (tabData.length > 0) {
      tabData = generateTabData(currentEvents);
      drawTab(tabData);
      $('tab-note-count').textContent = tabData.length;
    }
  } catch(e) { showStatus('ff-status', e.message, 'error'); }
  finally { btn.disabled = false; }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â• GUITAR TABLATURE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let tabData = [];

const TAB_LINE_SPACING = 22;
const TAB_PADDING_TOP = 28;
const TAB_PADDING_BOTTOM = 10;
const TAB_STRING_LABELS = ['e','B','G','D','A','E'];
const STRING_PITCHES = [64, 59, 55, 50, 45, 40];

function generateTabData(events) {
  let fretCenter = 5;
  const data = [];
  for (const evt of events) {
    const pitch = evt.note;
    const candidates = [];
    for (let sIdx = 0; sIdx < STRING_PITCHES.length; sIdx++) {
      const fret = pitch - STRING_PITCHES[sIdx];
      if (fret >= 0 && fret <= 24) candidates.push({string: sIdx, fret});
    }
    if (!candidates.length) continue;

    const best = candidates.reduce((a, b) => {
      const sa = Math.abs(a.fret - fretCenter) * 1.5 + a.string * 0.2;
      const sb = Math.abs(b.fret - fretCenter) * 1.5 + b.string * 0.2;
      return sa < sb ? a : b;
    });
    fretCenter = fretCenter * 0.7 + best.fret * 0.3;

    data.push({
      string: best.string,
      fret: best.fret,
      start: evt.start,
      end: evt.end,
      note: evt.note,
      technique: evt.technique || 'normal',
    });
  }
  return data;
}

function drawTab(tData) {
  const canvas = $('tab-canvas');
  const ctx = canvas.getContext('2d');
  const zoom = parseFloat($('tab-zoom').value);

  const canvasH = TAB_PADDING_TOP + (5 * TAB_LINE_SPACING) + TAB_PADDING_BOTTOM;
  const canvasW = prCanvasW() * zoom;

  const dpr = window.devicePixelRatio || 1;
  canvas.width = canvasW * dpr;
  canvas.height = canvasH * dpr;
  canvas.style.width = canvasW + 'px';
  canvas.style.height = canvasH + 'px';
  ctx.setTransform(dpr, 0, 0, dpr, 0, 0);

  // Background
  ctx.fillStyle = '#12121f';
  ctx.fillRect(0, 0, canvasW, canvasH);

  // 6 string lines
  ctx.lineWidth = 1;
  for (let s = 0; s < 6; s++) {
    const y = TAB_PADDING_TOP + s * TAB_LINE_SPACING;
    ctx.strokeStyle = (s === 0 || s === 5) ? '#4a4a6e' : '#3a3a5e';
    ctx.beginPath();
    ctx.moveTo(40, y);
    ctx.lineTo(canvasW, y);
    ctx.stroke();

    // String label
    ctx.fillStyle = '#888';
    ctx.font = '12px monospace';
    ctx.textAlign = 'right';
    ctx.fillText(TAB_STRING_LABELS[s], 35, y + 4);
  }

  // Time grid (match piano roll)
  const gridMs = prState.zoomX >= 2 ? 500 : (prState.zoomX >= 1 ? 1000 : 2000);
  ctx.strokeStyle = '#1a1a2e'; ctx.lineWidth = 0.5;
  for (let ms = 0; ms <= prState.maxEndMs; ms += gridMs) {
    const x = msToX(ms) * zoom;
    ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvasH); ctx.stroke();
  }

  // Fret numbers
  ctx.textAlign = 'center';
  ctx.font = 'bold 11px monospace';

  const techColors = {
    bend:'#00b894', slide:'#a29bfe',
    hammer_on:'#fdcb6e', pull_off:'#fd79a8',
    vibrato:'#74b9ff', normal:'#e0e0e8'
  };

  for (let i = 0; i < tData.length; i++) {
    const t = tData[i];
    const x = msToX(t.start) * zoom;
    const y = TAB_PADDING_TOP + t.string * TAB_LINE_SPACING;

    const numStr = String(t.fret);
    const tw = ctx.measureText(numStr).width + 6;

    // Background behind number
    ctx.fillStyle = '#12121f';
    ctx.fillRect(x - tw/2, y - 8, tw, 16);

    // Colored number
    ctx.fillStyle = techColors[t.technique] || techColors.normal;
    ctx.fillText(numStr, x, y + 4);

    // Technique symbols
    if (t.technique === 'bend') {
      ctx.strokeStyle = '#00b894';
      ctx.lineWidth = 1.5;
      ctx.beginPath();
      ctx.moveTo(x + tw/2 + 2, y);
      ctx.quadraticCurveTo(x + tw/2 + 8, y - 12, x + tw/2 + 14, y);
      ctx.stroke();
    }
    else if (t.technique === 'slide' && i + 1 < tData.length) {
      const nxt = tData[i + 1];
      const nx = msToX(nxt.start) * zoom;
      const ny = TAB_PADDING_TOP + nxt.string * TAB_LINE_SPACING;
      ctx.strokeStyle = '#a29bfe';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(x + tw/2 + 2, y);
      ctx.lineTo(nx - ctx.measureText(String(nxt.fret)).width/2 - 4, ny);
      ctx.stroke();
    }
    else if (t.technique === 'hammer_on' || t.technique === 'pull_off') {
      const label = t.technique === 'hammer_on' ? 'h' : 'p';
      ctx.fillStyle = techColors[t.technique];
      ctx.font = '9px monospace';
      ctx.fillText(label, x, y - 10);
      ctx.font = 'bold 11px monospace';
    }
    else if (t.technique === 'vibrato') {
      ctx.strokeStyle = '#74b9ff';
      ctx.lineWidth = 1;
      ctx.beginPath();
      for (let wx = 0; wx < 16; wx += 4) {
        const wy = y - 10 + Math.sin(wx * 1.2) * 3;
        if (wx === 0) ctx.moveTo(x - 8 + wx, wy);
        else ctx.lineTo(x - 8 + wx, wy);
      }
      ctx.stroke();
    }
  }

  // Playhead
  if (prState.playing || prState.playOffset > 0) {
    const phX = msToX(getCurrentPlayMs()) * zoom * dpr;
    ctx.save();
    ctx.setTransform(1,0,0,1,0,0);
    ctx.strokeStyle = '#ff4757';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(phX, 0);
    ctx.lineTo(phX, canvas.height);
    ctx.stroke();
    ctx.restore();
  }
}

$('btn-gen-tab').onclick = () => {
  if (!currentEvents.length) return;
  tabData = generateTabData(currentEvents);
  drawTab(tabData);
  $('tab-note-count').textContent = tabData.length;
};

$('tab-zoom').oninput = function() {
  if (tabData.length) drawTab(tabData);
};

// Scroll sync: piano roll â†” tab
$('pr-scroll').addEventListener('scroll', function() {
  const tabScroll = $('tab-scroll');
  const zoom = parseFloat($('tab-zoom').value);
  tabScroll.scrollLeft = this.scrollLeft * zoom;
});
$('tab-scroll').addEventListener('scroll', function() {
  const prScrollEl = $('pr-scroll');
  const zoom = parseFloat($('tab-zoom').value);
  prScrollEl.scrollLeft = this.scrollLeft / zoom;
});
</script>
</body>
</html>
